<ngx-spinner bdColor = "rgba(0, 0, 0, 0.8)" size = "medium" color = "#fff" type = "ball-beat" [fullScreen] = "true"><p style="color: white" > Loading... </p></ngx-spinner>
<p-toast></p-toast>
<p-confirmDialog [style]="{width: '50vw'}"></p-confirmDialog>
<p-overlayPanel #op>
	<div style="width: 200px;margin-left: auto;" class="mr-4 shadow">
		<table class="table">
			<tbody>
				<tr>
					<td>Net Amount</td>
					<td class="text-right">{{billSummary.bsnamt | number : '1.2-2'}}</td>
				</tr>
				<tr>
					<td>Total CGST</td>
					<td class="text-right">{{billSummary.bstcgst | number : '1.2-2'}}</td>
				</tr>
				<tr>
					<td>Total SGST</td>
					<td class="text-right">{{billSummary.bstsgst | number : '1.2-2'}}</td>
				</tr>
				<tr>
					<td>Final Amount</td>
					<td class="text-right">{{billSummary.bsfamt | number : '1.2-2'}}</td>
				</tr>
			</tbody>
		</table>
	</div>
</p-overlayPanel>

<div class="flex gap-4 justify-content-between">
    <div class="flex gap-3 align-items-center">
        <div>
            <p-radioButton name="reportFormat" value="S" [(ngModel)]="reportFormat"/>
            <label for="reportFormat" class="ml-2">
                Single Month
            </label>
        </div>
        <div>
            <p-radioButton name="reportFormat" value="M" [(ngModel)]="reportFormat"/>
            <label for="reportFormat" class="ml-2">
                Multiple Months
            </label>
        </div>
        <div>

        </div>
    </div>
    <div class="flex gap-3">
        <div *ngIf="reportFormat == 'S'">
            Date:&nbsp;&nbsp;
            <p-calendar [(ngModel)]="filterDate" view="month" dateFormat="mm-yy" (onSelect) ="filterInvoice()" #filter></p-calendar>
        </div>
    
        <div *ngIf="reportFormat == 'M'">
            Date:&nbsp;&nbsp;
            <p-calendar [(ngModel)]="filterMonths" view="month" dateFormat="mm-yy" (onSelect) ="filterInvoice()" 
             selectionMode="multiple" [readonlyInput]="true" #filter></p-calendar>
        </div>
    </div>
    
</div>

<div class="flex my-4">
    <div class="flex gap-3 align-items-center">
        <button pButton label="Clear" pRipple class="p-button-outlined" icon="pi pi-filter-slash" (click)="clear(dt1)"></button>
        <button pButton label="Download" pRipple class="p-button-outlined" icon="pi pi-file-excel" (click)="exportExcel(dt1)" pTooltip="XLSX" tooltipPosition="bottom"></button>
        <i class="pi pi-info-circle"style="font-size: 2rem;color: var(--primary-color)"  (click)="op.toggle($event)" pTooltip="Bill Summary" tooltipPosition="bottom"></i>
        <div style="font-weight:700;font-size: large;">Total Amount: {{billSummary.bsfamt | number : '1.2-2'}}</div>
    </div>
    <span class="p-input-icon-left ml-auto">
        <i class="pi pi-search"></i>
        <input pInputText type="text" id="searchText" (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Search keyword" />
    </span>
</div>

<p class="text-center">To filter single date, use format MMM DD YYYY e.g. Mar 31 2025</p>
<p-table #dt1 [value]="invoiceDetails" [tableStyle]="{ 'min-width': '50rem' }"
    [paginator]="true"
    [rows]="10"
    [loading]="loading"
    [showCurrentPageReport]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [globalFilterFields]="['tnbillno','tntime','tnname','tnpgst','gngstp','gntxable','gncamt','gnsamt','gntamt','tnbilltype']"
    (onFilter)="reCalculate($event)"
    >
    <ng-template pTemplate="header" let-columns>
        <tr>
            <th>
                <div class="flex align-items-center">
                Invoice
                <p-columnFilter type="text" field="tnbillno" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                Invoice Date
                <p-columnFilter type="date" field="tntime" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                Customer Name
                <p-columnFilter type="text" field="tnname" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                GST %
                <p-columnFilter type="text" field="gngstp" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                Total Amount
                <p-columnFilter type="numeric" field="gntxable" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                CGST
                <p-columnFilter type="numeric" field="gncamt" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                SGST
                <p-columnFilter type="numeric" field="gnsamt" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                Grand Total
                <p-columnFilter type="numeric" field="gntamt" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>
                <div class="flex align-items-center">
                Bill Type
                <p-columnFilter type="text" field="tnbilltype" display="menu"></p-columnFilter>
                </div>
            </th>
            <th>Action</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowData>
        <tr [ngClass]="{'bg-red':rowData.invalid}">
            <td>{{rowData.tnbillno}}</td>
            <td>{{rowData.tntime | date: 'dd-MM-yyyy'}}</td>
            <td>{{rowData.tnname}}</td>
            <td class="text-right">{{rowData.gngstp}}</td>
            <td class="text-right">{{rowData.gntxable | number : '1.2-2'}}</td>
            <td class="text-right">{{rowData.gncamt | number : '1.2-2'}}</td>
            <td class="text-right">{{rowData.gnsamt | number : '1.2-2'}}</td>
            <td class="text-right">{{rowData.gntamt | number : '1.2-2'}}</td>
            <td class="text-center">{{rowData.tnbilltype}}</td>
            <td>
                <div class="flex gap-3">
                    <div *ngIf="rowData.tnbilltype !== 'Q'">
                        <a [routerLink]="['/home/tax-invoice/' + rowData.tnbillno + '/' + rowData.tnbilltype]">
                            <i class="pi pi-eye" style="font-size: 1.5rem;cursor: pointer;" pTooltip="View" 
                                tooltipPosition="bottom">
                            </i>
                        </a>
                    </div>
                    <div *ngIf="rowData.tnbilltype === 'Q'">
                        <a [routerLink]="['/home/quotation/' + rowData.tnbillno]">
                            <i class="pi pi-eye" style="font-size: 1.5rem;cursor: pointer;" pTooltip="View" 
                                tooltipPosition="bottom">
                            </i>
                        </a>
                    </div>
                    <i class="pi pi-trash" style="font-size: 1.5rem;cursor: pointer;color:red" pTooltip="Delete" 
                        tooltipPosition="bottom" (click)="delete(rowData)"></i>
                </div>
            </td>
    </ng-template>
    <ng-template pTemplate="paginatorleft">
        <i class="pi pi-filter-slash" style="font-size: 1.5rem;cursor: pointer;" pTooltip="Clear Filter" 
        tooltipPosition="bottom" (click)="clear(dt1)"></i>
    </ng-template>
    <ng-template pTemplate="paginatorright">
        <i class="pi pi-file-excel" style="font-size: 2rem;cursor: pointer;" pTooltip="XLSX" 
        tooltipPosition="bottom" (click)="exportExcel(dt1)"></i>
    </ng-template>
    <ng-template pTemplate="emptymessage" let-columns>
        <tr>
            <td colspan="10">No records found</td>
        </tr>
        </ng-template>
</p-table>
