<ngx-spinner bdColor = "rgba(0, 0, 0, 0.8)" size = "medium" color = "#fff" type = "ball-beat" [fullScreen] = "true"><p style="color: white" > Loading... </p></ngx-spinner>
<p-toast></p-toast>
<p-confirmDialog [style]="{width: '50vw'}"></p-confirmDialog>
<p-card header = "Purchase History">
    <div class="flex mb-4">
        <div class="flex gap-3">
            <button pButton label="Clear" pRipple class="p-button-outlined" icon="pi pi-filter-slash" (click)="clearFilter(dt1)" pTooltip="Clear Filter" tooltipPosition="bottom"></button>
            <button pButton label="Download" pRipple class="p-button-outlined" icon="pi pi-file-excel" (click)="exportExcel(dt1)" pTooltip="XLSX" tooltipPosition="bottom"></button>
            <button pButton label="Add Bill" pRipple class="p-button-outlined" icon="pi pi-file-excel" (click)="addBill()" pTooltip="Add Bill" tooltipPosition="bottom"></button>
            <div>
                Date:&nbsp;&nbsp;
                <p-calendar [(ngModel)]="filterDate" view="month" dateFormat="mm-yy" (onSelect) ="filterPurchase()" #filter></p-calendar>
            </div>
        </div>
        <span class="p-input-icon-left ml-auto">
            <i class="pi pi-search"></i>
            <input pInputText type="text" id="searchText" (input)="dt1.filterGlobal($event.target.value, 'contains')" placeholder="Search keyword" />
        </span>
    </div>
    
    <p-table #dt1 [value]="purchaseDetails" [tableStyle]="{ 'min-width': '50rem' }"
        [paginator]="true"
        [rows]="10"
        [loading]="loading"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 25, 50]"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [globalFilterFields]="['arbillno', 'ardate', 'arname','arnamt','arcgst','arsgst','artamt']"
        >
        <ng-template pTemplate="header" let-columns>
            <tr>
                <th>
                    <div class="flex align-items-center">
                    Invoice
                    <p-columnFilter type="text" field="arbillno" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>
                    <div class="flex align-items-center">
                    Purchase Date
                    <p-columnFilter type="date" field="ardate" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>
                    <div class="flex align-items-center">
                    Company Name
                    <p-columnFilter type="text" field="arname" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>
                    <div class="flex align-items-center">
                    Net Amount
                    <p-columnFilter type="numeric" field="arnamt" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>
                    <div class="flex align-items-center">
                    CGST
                    <p-columnFilter type="numeric" field="arcgst" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>
                    <div class="flex align-items-center">
                    SGST
                    <p-columnFilter type="numeric" field="arsgst" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>
                    <div class="flex align-items-center">
                    Total Amount
                    <p-columnFilter type="numeric" field="artamt" display="menu"></p-columnFilter>
                    </div>
                </th>
                <th>Action</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rowData>
            <tr>
                <td>{{rowData.arbillno}}</td>
                <td>{{rowData.ardate | date: 'dd-MM-yyyy'}}</td>
                <td>{{rowData.arname}}</td>
                <td class="text-right">{{rowData.arnamt | number : '1.2-2'}}</td>
                <td class="text-right">{{rowData.arcgst | number : '1.2-2'}}</td>
                <td class="text-right">{{rowData.arsgst | number : '1.2-2'}}</td>
                <td class="text-right">{{rowData.artamt | number : '1.2-2'}}</td>
                <td>
                    <div class="flex gap-3">
                        <i class="pi pi-eye" style="font-size: 1.5rem;cursor: pointer;" pTooltip="View" 
                            tooltipPosition="bottom" (click)="view(rowData)"></i>
                        <i class="pi pi-trash" style="font-size: 1.5rem;cursor: pointer;" pTooltip="Delete" 
                            tooltipPosition="bottom" (click)="delete(rowData)"></i>
                    </div>
                </td>
        </ng-template>
        <ng-template pTemplate="paginatorleft">
            <i class="pi pi-filter-slash" style="font-size: 1.5rem;" (click)="clearFilter(dt1)" pTooltip="Clear Filter" tooltipPosition="bottom"></i>
        </ng-template>
        <ng-template pTemplate="paginatorright">
            <i class="pi pi-file-excel" style="font-size: 2rem;" (click)="exportExcel(dt1)" pTooltip="XLSX" tooltipPosition="bottom"></i>
        </ng-template>
        <ng-template pTemplate="emptymessage" let-columns>
            <tr>
              <td colspan="8">No records found</td>
            </tr>
          </ng-template>
    </p-table>
</p-card>

<p-dialog header="Add/Edit Bills" [(visible)]="visible" [position]="'top'" [style]="{ width: '80vw' }">
	<div class="grid">
		<div class="col">
			<p-fieldset legend="Bill Details">
				<div class="field grid">
					<label htmlFor="arbillno" class="col-12 mb-2 md:col-5 md:mb-0 font-bold">
                        Invoice Number
                    </label>
					<div class="col-12 md:col-7">
                        <p-autoComplete [(ngModel)]="purchaseBill.arbillno" [suggestions]="filteredInvoice" 
                            (completeMethod)="searchInvoice($event)" (onSelect)="populateBill()" (onBlur)="populateBill()"> 
                        </p-autoComplete>
					</div>
				</div>

                <div class="field grid">
					<label htmlFor="ardate" class="col-12 mb-2 md:col-5 md:mb-0 font-bold">
                        Invoice Date<span class="text-danger">&nbsp;*</span>
                    </label>
					<div class="col-12 md:col-7">
						<p-calendar dateFormat="yy-mm-dd"  [appendTo]="'body'" [showButtonBar]="true" 
                        [(ngModel)] ="purchaseBill.ardate"></p-calendar>
					</div>
				</div>

				<div class="field grid">
					<label htmlFor="arname" class="col-12 mb-2 md:col-5 md:mb-0 font-bold">
                        Company Name *
                    </label>
					<div class="col-12 md:col-7">
                        <p-autoComplete [(ngModel)]="purchaseBill.arname" [suggestions]="filteredCustomers" 
                            (completeMethod)="searchSuggestion($event)" (onSelect)="populateDetails()"> 
                        </p-autoComplete>
					</div>
				</div>

				<div class="field grid">
					<label htmlFor="argstno" class="col-12 mb-2 md:col-5 md:mb-0 font-bold">
                        Company GST
                    </label>
					<div class="col-12 md:col-7">
						<input pInputText  type="text" [(ngModel)] ="purchaseBill.argstno"/>
					</div>
				</div>				
			</p-fieldset>
		</div>

		<div class="col">
			<p-fieldset legend="Bill Amount">
				<div class="field grid">
					<label htmlFor="mobile" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
                        Net Amount *
                    </label>
					<div class="col-12 md:col-9">
						<input id="namt" pInputText type="number" [(ngModel)] ="purchaseBill.arnamt" (ngModelChange)="calculate('arnamt')">
					</div>
				</div>
				
				<div class="field grid">
					<label htmlFor="arcgst" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
                        CGST <span class="text-danger">&nbsp;*</span>
                    </label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)] ="purchaseBill.arcgst" (ngModelChange)="calculate('arcgst')">
					</div>
				</div>
				
				<div class="field grid">
					<label htmlFor="arsgst" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
                        SGST <span class="text-danger">&nbsp;*</span>
                    </label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)] ="purchaseBill.arsgst" (ngModelChange)="calculate('arsgst')">
					</div>
				</div>

				<div class="field grid">
					<label htmlFor="artamt" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Total Amount *</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)] ="purchaseBill.artamt" (ngModelChange)="calculate('artamt')">
					</div>
				</div>
				
			</p-fieldset>
		</div>

        <div class="col">
			<p-fieldset legend="Bank Details">
				<div class="field grid">
					<label htmlFor="archqno" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Cheque Number</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)] ="purchaseBill.archqno" />
					</div>
				</div>
				
				<div class="field grid">
					<label htmlFor="archqdte" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Cheque Date</label>
					<div class="col-12 md:col-9"> 
						<p-calendar [appendTo]="'body'" dateFormat="yy-mm-dd" [showButtonBar]="true"
                        [(ngModel)] ="purchaseBill.archqdte"></p-calendar>
					</div>
				</div>
				
                <div class="field grid">
					<label htmlFor="archqamt" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Cheque Amount</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)] ="purchaseBill.archqamt" />
					</div>
				</div>

				<div class="field grid">
					<label htmlFor="arbname" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Bank Name</label>
					<div class="col-12 md:col-9">
						<input pInputText type="text" [(ngModel)] ="purchaseBill.arbname"/>
					</div>
				</div>

				<div class="field grid">
					<label htmlFor="artext" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Comments</label>
					<div class="col-12 md:col-9">
						<input pInputText type="text" [(ngModel)] ="purchaseBill.artext"/>
					</div>
				</div>
				
			</p-fieldset>
		</div>
	</div>
	
	<div class="flex justify-content-end gap-3">
		<p-button label = "Save" (click)="save()"></p-button>
		<p-button label = "Clear" (click)="clear()"></p-button>
	</div>
</p-dialog>
