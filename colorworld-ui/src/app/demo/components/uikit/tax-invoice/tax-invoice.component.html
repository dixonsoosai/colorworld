<ngx-spinner bdColor = "rgba(0, 0, 0, 0.8)" size = "medium" color = "#fff" type = "ball-beat" [fullScreen] = "true"><p style="color: white" > Loading... </p></ngx-spinner>
<p-toast></p-toast>
<p-confirmDialog [style]="{width: '50vw'}"></p-confirmDialog>
<p-card>
	<p-tabMenu [model]="items" [activeItem]="activeItem" (activeItemChange)="onActiveItemChange($event)"></p-tabMenu>

	<div id="products" *ngIf="this.activeItem.label == 'Products'">
		<div class="flex justify-content-between mt-4">
			<div class="field grid">
				<label htmlFor="name3" class="col-12 mb-2 md:col-2 md:mb-0">Search</label>
				<div class="col-12 md:col-10">
					<span class="p-input-icon-left">
						<i class="pi pi-search"></i>
						<input type="text" pInputText (keyup)="filter($event)" />
					</span>
				</div>
			</div>
			<div class="flex justify-content-between gap-3">
				<p-multiSelect [options]="units" [(ngModel)]="filteredUnits" optionLabel="name"
					defaultLabel="Select a Unit">
				</p-multiSelect>
			</div>

		</div>
		<div class="flex flex-wrap gap-4" id="productView">
			<div *ngFor="let product of productList" style="width:32%;height:100%" class="my-2">
				<p-card>
					<h4>{{product.pnscnm}}</h4>
					<p class="card-text">{{product.pncmpy}}</p>
					<div class="flex row justify-content-between">
						<span>Product Code</span>
						<b>{{product.pnpdcd}}</b>
					</div>
					<div class="flex row justify-content-between">
						<span>Product Name</span>
						<b>{{product.pnscnm}}</b>
					</div>
					<div class="row flex justify-content-between">
						<span>Quantity</span>
						<b>{{product.pnuqty + " " + product.pnunit}}</b>
					</div>
					<div class="row flex justify-content-between">
						<span>Price</span>
						<b>{{product.pncuspr}}</b>
					</div>
					<div class="mt-4 flex justify-content-end gap-3">
						<p-button label="Add to Cart" styleClass="p-button-outlined" icon="pi pi-shopping-cart"
							(click)="addToCart(product)"></p-button>
					</div>
				</p-card>
			</div>
		</div>
	</div>

	<div id="tax-invoice" *ngIf="this.activeItem.label == 'Invoice'">
		<div class="mt-4">
			<div>
				<div class="grid">
					<div class="lg:col md:col-6">
						<div class="field grid">
							<label htmlFor="customerName" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Customer
								Name</label>
							<div class="col-12 md:col-9">
								<p-autoComplete [(ngModel)]="header.tnname" [suggestions]="filteredCustomers" 
									(completeMethod)="searchSuggestion($event)" (onSelect)="populateDetails()"> 
								</p-autoComplete>
							</div>
						</div>
					</div>
					<div class="lg:col md:col-6">
						<div class="field grid">
							<label htmlFor="gst" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">GST</label>
							<div class="col-12 md:col-9">
								<input pInputText type="text" [(ngModel)]="header.tnpgst" />
							</div>
						</div>
					</div>
					<div class="lg:col md:col-6">
						<div class="field grid">
							<label htmlFor="mobile" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Mobile</label>
							<div class="col-12 md:col-9">
								<input pInputText type="number" [(ngModel)]="header.tnmobno">
							</div>
						</div>
					</div>
					<div class="lg:col md:col-6">
						<div class="field grid">
							<label htmlFor="balance" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Balance</label>
							<div class="col-12 md:col-9">
								<input pInputText type="number" [(ngModel)]="header.tnprvbn">
							</div>
						</div>
					</div>
				</div>
				<div class="grid">
					<div class="col-8">
						<div class="field grid">
							<label htmlFor="address" class="col-12 mb-2 md:col-1 md:mb-0 font-bold">Address</label>
							<div class="col-12 md:col">
								<textarea rows="2" pInputTextarea [autoResize]="true" style="width: 100%;"
									[(ngModel)]="header.tnadd"></textarea>
							</div>
						</div>
					</div>
					<div class="col">
						<div class="field grid">
							<label htmlFor="balance" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">Overflow Limit</label>
							<div class="col-12 md:col-9">
								<input pInputText type="number" [(ngModel)]="overflowLimit">
							</div>
						</div>
					</div>
				</div>				
			</div>
		</div>

		<div class="mt-4">
			<div style="width: 100%;">
				<div class="flex justify-content-between">
					<div class="field grid">
						<label htmlFor="invoiceNumber" class="col-12 mb-2 md:col-5 md:mb-0 font-bold">Invoice
							Number</label>
						<div class="col-12 md:col-7">
							<div class="flex gap-2 align-items-center">
								<input pInputText type="text" [(ngModel)]="header.tnbillno" />
								<i class="pi pi-check" style="color: green;cursor: pointer;" pTooltip="New Bill" 
									tooltipPosition="bottom" *ngIf="newBill"></i>
							</div>
						</div>
					</div>
					<div class="field grid">
						<div class="flex gap-2">
							<label htmlFor="invoiceDate" class="col-12 mb-2 md:col-5 md:mb-0 font-bold">
								Invoice Date
							</label>
							<p-calendar dateFormat="yy-mm-dd"  [appendTo]="'body'" [showButtonBar]="true" 
								[(ngModel)]="invoiceDate"></p-calendar>
						</div>
					</div>
				</div>
				<p-table [value]="selectedProducts" dataKey="pnpdcd" editMode="row"
					[tableStyle]="{ 'min-width': '50rem' }" [rows]="10" [showCurrentPageReport]="false"
					[rowsPerPageOptions]="[10, 25, 50]" [paginator]="true"
					currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries">
					<ng-template pTemplate="header">
						<tr>
							<th style="width:10%"></th>
							<th style="width:10%">Challan</th>
							<th style="width:25%">Product</th>
							<th style="width:15%">HSNC</th>
							<th style="width:10%">Total Qty</th>
							<th style="width:10%">Unit Qty</th>
							<th style="width:10%">Unit</th>
							<th style="width:10%">Unit Price</th>
							<th style="width:10%">Disc (%)</th>
							<th style="width:10%">Net Amount</th>
							<th style="width:10%">CGST (%)</th>
							<th style="width:10%">CGST</th>
							<th style="width:10%">SGST (%)</th>
							<th style="width:10%">SGST</th>
							<th style="width:10%">Total Amount</th>
							<th style="width:10%">Action</th>
						</tr>
					</ng-template>
					<ng-template pTemplate="emptymessage" let-columns>
						<tr>
							<td [attr.colspan]="16" class="text-center">
								No records found
							</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="body" let-cproduct let-editing="editing" let-index="rowIndex">
						<tr [pEditableRow]="cproduct" [pReorderableRow]="index">
							<td><span class="pi pi-bars" pReorderableRowHandle></span></td>
							<td [pEditableColumn]="cproduct.tnchallan" pEditableColumnField="tnchallan">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="text" [(ngModel)]="cproduct.tnchallan">
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnchallan}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td [pEditableColumn]="cproduct.tnscnnm" pEditableColumnField="tnscnnm">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="text" [(ngModel)]="cproduct.tnscnnm">
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnscnnm}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td [pEditableColumn]="cproduct.tnhsnc" pEditableColumnField="tnhsnc">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="text" [(ngModel)]="cproduct.tnhsnc">
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnhsnc}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td [pEditableColumn]="cproduct.tntqty" pEditableColumnField="tntqty">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tntqty"
											(ngModelChange)="onChange($event, cproduct, 'tqty')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tntqty}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td [pEditableColumn]="cproduct.tnuqty" pEditableColumnField="tnuqty">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tnuqty">
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnuqty}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td [pEditableColumn]="cproduct.tnunit" pEditableColumnField="tnunit">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="text" [(ngModel)]="cproduct.tnunit">
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnunit}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-right" [pEditableColumn]="cproduct.tnprice" pEditableColumnField="tnprice">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tnprice"
											(ngModelChange)="onChange($event, cproduct, 'tnprice')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnprice}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-right" [pEditableColumn]="cproduct.tndisc" pEditableColumnField="tndisc">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tndisc"
											(ngModelChange)="onChange($event, cproduct, 'tndisc')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tndisc}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-right" [pEditableColumn]="cproduct.tntxable" pEditableColumnField="tntxable">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tntxable"
											(ngModelChange)="onChange($event, cproduct, 'namt')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tntxable}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-right" [pEditableColumn]="cproduct.tncgst" pEditableColumnField="tncgst">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tncgst"
											(ngModelChange)="onChange($event, cproduct, 'cgst')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tncgst}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-right">{{cproduct.tncamt}}</td>
							<td class="text-right" [pEditableColumn]="cproduct.tnsgst" pEditableColumnField="tnsgst">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tnsgst"
											(ngModelChange)="onChange($event, cproduct, 'sgst')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tnsgst}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-right">
								{{cproduct.tnsamt}}
							</td>
							<td class="text-right" [pEditableColumn]="cproduct.tntamt" pEditableColumnField="tntamt">
								<p-cellEditor>
									<ng-template pTemplate="input">
										<input pInputText type="number" [(ngModel)]="cproduct.tntamt"
											(ngModelChange)="onChange($event, cproduct, 'tntamt')">
										
									</ng-template>
									<ng-template pTemplate="output">
										{{cproduct.tntamt}}
									</ng-template>
								</p-cellEditor>
							</td>
							<td class="text-left">
								<div class="flex gap-3">						
									<i class="pi pi-copy" style="cursor: pointer;"
										pTooltip="Copy" tooltipPosition="bottom" (click)="copy(cproduct)"></i>
									<i class="pi pi-times" style="cursor: pointer;"
										pTooltip="Delete" tooltipPosition="bottom" (click)="delete(index)"></i>
								</div>
							</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="paginatorleft">
						<i class="pi pi-plus-circle" style="font-size: 1.5rem;cursor: pointer;"
							(click)="visible = true" pTooltip="Add Product" tooltipPosition="bottom"></i>
					</ng-template>
				</p-table>

				<!--Final Total & GST Summary-->
				<p-card header="Bill Summary">
					<div class="flex justify-content-between">
						<div>
							<table class="table">
								<thead>
									<th class="text-center">GST Type</th>
									<th class="text-center">Net Amount</th>
									<th class="text-center">Total CGST</th>
									<th class="text-center">Total SGST</th>
									<th class="text-center">Total Amount</th>
								</thead>
								<tbody>
									<tr *ngFor="let gst of gstSummary| keyvalue">
										<td>{{gst.value.gngstp}}</td>
										<td class="text-right">{{gst.value.gntxable | number : '1.2-2'}}</td>
										<td class="text-right">{{gst.value.gncamt | number : '1.2-2'}}</td>
										<td class="text-right">{{gst.value.gnsamt | number : '1.2-2'}}</td>
										<td class="text-right">{{gst.value.gntamt | number : '1.2-2'}}</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div style="width: 200px;" class="mr-4">
							<table class="table">
								<tbody>
									<tr>
										<td>Net Amount</td>
										<td class="text-right">{{billSummary.bsnamt | number : '1.2-2'}}</td>
									</tr>
									<tr>
										<td>Total CGST</td>
										<td class="text-right">{{billSummary.bstcgst | number : '1.2-2'}}</td>
									</tr>
									<tr>
										<td>Total SGST</td>
										<td class="text-right">{{billSummary.bstsgst | number : '1.2-2'}}</td>
									</tr>
									<tr>
										<td>Total Amount</td>
										<td class="text-right">{{billSummary.bstamt | number : '1.2-2'}}</td>
									</tr>
									<tr>
										<td>Rounded Off</td>
										<td class="text-right">{{billSummary.bsroff | number : '1.2-2'}}</td>
									</tr>
									<tr>
										<td>Final Amount</td>
										<td class="text-right">{{billSummary.bsfamt | number : '1.2-2'}}</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</p-card>
				<div class="flex justify-content-start gap-3 mt-4 align-items-center">
					<p-button label="Generate Bill" (click)="generateBill()"></p-button>
					<p-button label="Clear Bill" (click)="clearBill()"></p-button>
					<div *ngIf="filename != ''">Filename : {{filename}}</div>
				</div>
			</div>
		</div>
	</div>

</p-card>


<p-dialog header="Add New Product" [(visible)]="visible" [position]="'top'" [style]="{ width: '80vw' }">
	<div class="grid">
		<div class="col">
			<p-fieldset legend="Description">
				<div class="field grid">
					<label htmlFor="pnscnm" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						Product Name<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<input pInputText type="text" style="width: 100%;" [(ngModel)]="newProduct.pnscnm" />
					</div>
				</div>
				<div class="field grid">
					<label htmlFor="pnuqty" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						Unit Qty<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)]="newProduct.pnuqty">
					</div>
				</div>

				<div class="field grid">
					<label htmlFor="units" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						Unit<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<p-dropdown [options]="units" [(ngModel)]="filteredUnits" optionLabel="name"></p-dropdown>
					</div>
				</div>
				<div class="field grid">
					<label htmlFor="pnmcpr" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						Product Price<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)]="newProduct.pnmcpr">
					</div>
				</div>
			</p-fieldset>
		</div>
		<div class="col">
			<p-fieldset legend="GST">
				<div class="field grid">
					<label htmlFor="pnhsnc" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						HSNC<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<input pInputText type="text" style="width: 100%;" [(ngModel)]="newProduct.pnhsnc" />
					</div>
				</div>
				<div class="field grid">
					<label htmlFor="pncgst" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						CGST<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)]="newProduct.pncgst">
					</div>
				</div>
				<div class="field grid">
					<label htmlFor="pnsgst" class="col-12 mb-2 md:col-3 md:mb-0 font-bold">
						SGST<span class="text-danger">&nbsp;*</span>
					</label>
					<div class="col-12 md:col-9">
						<input pInputText type="number" [(ngModel)]="newProduct.pnsgst">
					</div>
				</div>
			</p-fieldset>
		</div>
	</div>

	<div class="flex justify-content-end gap-3">
		<p-button label="Add" (click)="addProduct()"></p-button>
		<p-button label="Clear" (click)="clearProduct()"></p-button>
	</div>
</p-dialog>